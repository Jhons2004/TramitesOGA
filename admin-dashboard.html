<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üèõÔ∏è Panel Administrativo OGA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --secondary: #f093fb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --surface: #ffffff;
      
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-tertiary: #94a3b8;
      
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --radius: 8px;
      --transition: all 0.3s ease;
    }

    .dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-tertiary: #334155;
      --surface: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-tertiary: #94a3b8;
      --border: #334155;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: var(--transition);
    }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-warning { background: var(--warning); color: white; }

    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 2rem;
    }

    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 1rem 1.5rem;
      border: none;
      background: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--surface);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      text-align: center;
      border-left: 4px solid var(--primary);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }

    .stat-label {
      color: var(--text-secondary);
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      background: var(--surface);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .table th,
    .table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .table th {
      background: var(--bg-tertiary);
      font-weight: 600;
      color: var(--text-primary);
    }

    .status {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-nuevo { background: rgba(59, 130, 246, 0.1); color: var(--info); }
    .status-proceso { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
    .status-completado { background: rgba(16, 185, 129, 0.1); color: var(--success); }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }

    .modal-content {
      background: var(--surface);
      padding: 2rem;
      border-radius: var(--radius);
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    @media (max-width: 768px) {
      .header {
        padding: 1rem;
        flex-direction: column;
        gap: 1rem;
      }

      .container {
        padding: 1rem;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .table {
        font-size: 0.875rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>üèõÔ∏è Panel Administrativo OGA</h1>
    <div class="user-info">
      <span id="user-name"></span>
      <span id="user-role"></span>
      <button class="btn btn-danger" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-cases">0</div>
        <div class="stat-label">Casos Totales</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pending-cases">0</div>
        <div class="stat-label">Casos Pendientes</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="active-officers">0</div>
        <div class="stat-label">Oficiales Activos</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="completed-cases">0</div>
        <div class="stat-label">Casos Completados</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('cases')">üìã Gesti√≥n de Casos</button>
      <button class="tab" onclick="showTab('officers')">üë®‚Äçüíº Oficiales</button>
      <button class="tab" onclick="showTab('reports')">üìä Reportes</button>
    </div>

    <!-- Cases Tab -->
    <div id="cases-tab" class="tab-content active">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>üéØ Casos sin Asignar</h3>
          <button class="btn btn-primary" onclick="refreshCases()">üîÑ Actualizar</button>
        </div>
        
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Fecha</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="unassigned-cases">
            <!-- Casos din√°micos -->
          </tbody>
        </table>
      </div>

      <div class="card">
        <h3>üìà Casos en Proceso</h3>
        <table class="table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Oficial</th>
              <th>Estado</th>
              <th>√öltima Actualizaci√≥n</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="active-cases">
            <!-- Casos din√°micos -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Officers Tab -->
    <div id="officers-tab" class="tab-content">
      <div class="card">
        <h3>üë®‚Äçüíº Oficiales de Acreditaci√≥n</h3>
        <table class="table">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Email</th>
              <th>Casos Asignados</th>
              <th>Casos Completados</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody id="officers-list">
            <!-- Oficiales din√°micos -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Reports Tab -->
    <div id="reports-tab" class="tab-content">
      <div class="card">
        <h3>üìä Reportes del Sistema</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="monthly-cases">0</div>
            <div class="stat-label">Casos Este Mes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="avg-resolution">0</div>
            <div class="stat-label">Tiempo Promedio (d√≠as)</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="client-satisfaction">0%</div>
            <div class="stat-label">Satisfacci√≥n Cliente</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Officer Modal -->
  <div id="assign-modal" class="modal">
    <div class="modal-content">
      <h3>üë®‚Äçüíº Asignar Oficial</h3>
      <div class="form-group">
        <label>Caso ID:</label>
        <input type="text" id="assign-case-id" readonly>
      </div>
      <div class="form-group">
        <label>Seleccionar Oficial:</label>
        <select id="officer-select">
          <option value="">Selecciona un oficial...</option>
        </select>
      </div>
      <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
        <button class="btn btn-danger" onclick="closeModal()">‚ùå Cancelar</button>
        <button class="btn btn-success" onclick="assignOfficer()">‚úÖ Asignar</button>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyLZ0usSR8hvItj_V9Hn7bSpgI8lk4TEa1SC_qLlvS53oO2OOnRy8ndRhE2_ngkDT-F/exec';
    let currentUser = null;

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      // Verificar usuario logueado
      const userData = localStorage.getItem('currentUser');
      if (!userData) {
        window.location.href = 'index.html';
        return;
      }

      currentUser = JSON.parse(userData);
      
      // Verificar permisos de administrador
      if (!['Admin', 'Jefe OGA', 'Director'].includes(currentUser.rol)) {
        alert('Acceso denegado. No tienes permisos de administrador.');
        window.location.href = 'index.html';
        return;
      }

      // Cargar informaci√≥n del usuario
      document.getElementById('user-name').textContent = currentUser.nombre;
      document.getElementById('user-role').textContent = `(${currentUser.rol})`;

      // Cargar datos
      loadDashboardData();
    });

    // Funciones de pesta√±as
    function showTab(tabName) {
      // Ocultar todas las pesta√±as
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Mostrar pesta√±a seleccionada
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
    }

    // Cargar datos del dashboard
    async function loadDashboardData() {
      try {
        // Cargar estad√≠sticas
        const tickets = await callAPI('getTicketsByRole', {
          userEmail: currentUser.email,
          userRole: currentUser.rol,
          userName: currentUser.nombre
        });

        updateStatistics(tickets);
        loadUnassignedCases(tickets);
        loadActiveCases(tickets);
        loadOfficers();
      } catch (error) {
        console.error('Error cargando datos:', error);
      }
    }

    // Actualizar estad√≠sticas
    function updateStatistics(tickets) {
      const totalCases = tickets.length;
      const pendingCases = tickets.filter(t => t.estado === 'Nuevo').length;
      const completedCases = tickets.filter(t => t.estado === 'Completado').length;

      document.getElementById('total-cases').textContent = totalCases;
      document.getElementById('pending-cases').textContent = pendingCases;
      document.getElementById('completed-cases').textContent = completedCases;
      document.getElementById('active-officers').textContent = '5'; // Mock data
    }

    // Cargar casos sin asignar
    function loadUnassignedCases(tickets) {
      const unassignedCases = tickets.filter(t => t.estado === 'Nuevo' && !t.oficialAsignado);
      const tbody = document.getElementById('unassigned-cases');
      
      tbody.innerHTML = unassignedCases.map(ticket => `
        <tr>
          <td>${ticket.id}</td>
          <td>${ticket.empresa}</td>
          <td>${ticket.tipoTramite}</td>
          <td>${new Date(ticket.fechaCreacion).toLocaleDateString()}</td>
          <td><span class="status status-nuevo">${ticket.estado}</span></td>
          <td>
            <button class="btn btn-primary" onclick="openAssignModal('${ticket.id}')">
              üë®‚Äçüíº Asignar
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Cargar casos activos
    function loadActiveCases(tickets) {
      const activeCases = tickets.filter(t => t.oficialAsignado && t.estado !== 'Completado');
      const tbody = document.getElementById('active-cases');
      
      tbody.innerHTML = activeCases.map(ticket => `
        <tr>
          <td>${ticket.id}</td>
          <td>${ticket.empresa}</td>
          <td>${ticket.oficialAsignado}</td>
          <td><span class="status status-proceso">${ticket.estado}</span></td>
          <td>${new Date(ticket.fechaActualizacion).toLocaleDateString()}</td>
          <td>
            <button class="btn btn-warning" onclick="viewCase('${ticket.id}')">
              üëÅÔ∏è Ver
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Cargar oficiales
    function loadOfficers() {
      // Mock data - en producci√≥n, llamar a la API
      const officers = [
        { nombre: 'Carlos M√©ndez', email: 'carlos@oga.gov.gt', asignados: 3, completados: 12 },
        { nombre: 'Ana Garc√≠a', email: 'ana@oga.gov.gt', asignados: 2, completados: 8 },
        { nombre: 'Luis Rodr√≠guez', email: 'luis@oga.gov.gt', asignados: 4, completados: 15 }
      ];

      const tbody = document.getElementById('officers-list');
      tbody.innerHTML = officers.map(officer => `
        <tr>
          <td>${officer.nombre}</td>
          <td>${officer.email}</td>
          <td>${officer.asignados}</td>
          <td>${officer.completados}</td>
          <td><span class="status status-completado">Activo</span></td>
        </tr>
      `).join('');

      // Cargar en el selector
      const select = document.getElementById('officer-select');
      select.innerHTML = '<option value="">Selecciona un oficial...</option>' +
        officers.map(officer => `<option value="${officer.nombre}">${officer.nombre}</option>`).join('');
    }

    // Modal de asignaci√≥n
    function openAssignModal(caseId) {
      document.getElementById('assign-case-id').value = caseId;
      document.getElementById('assign-modal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('assign-modal').classList.remove('show');
    }

    // Asignar oficial
    async function assignOfficer() {
      const caseId = document.getElementById('assign-case-id').value;
      const officerName = document.getElementById('officer-select').value;

      if (!officerName) {
        alert('Por favor selecciona un oficial');
        return;
      }

      try {
        const result = await callAPI('assignTicketToOfficer', {
          ticketId: caseId,
          oficialName: officerName,
          assignedBy: currentUser.nombre
        });

        if (result.success) {
          alert('Oficial asignado exitosamente');
          closeModal();
          loadDashboardData(); // Recargar datos
        } else {
          alert('Error al asignar oficial: ' + result.message);
        }
      } catch (error) {
        alert('Error de conexi√≥n');
        console.error(error);
      }
    }

    // Funciones auxiliares
    function refreshCases() {
      loadDashboardData();
    }

    function viewCase(caseId) {
      alert(`Ver detalles del caso: ${caseId}`);
      // Implementar vista detallada del caso
    }

    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userType');
      window.location.href = 'index.html';
    }

    // Funci√≥n API
    async function callAPI(action, params = {}) {
      try {
        const url = new URL(API_URL);
        url.searchParams.append('action', action);
        
        Object.keys(params).forEach(key => {
          if (params[key] !== null && params[key] !== undefined) {
            url.searchParams.append(key, params[key]);
          }
        });

        const response = await fetch(url.toString());
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }
  </script>
</body>
</html>