<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üè¢ Portal Cliente OGA</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* [CSS base similar a los anteriores, pero optimizado para chat] */
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #667eea;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --surface: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      background: var(--surface);
      border-radius: var(--radius);
      margin: 1rem;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .chat-header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .chat-messages {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      max-height: 400px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .message {
      max-width: 70%;
      padding: 0.75rem 1rem;
      border-radius: var(--radius);
      word-wrap: break-word;
    }

    .message-client {
      align-self: flex-end;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-official {
      align-self: flex-start;
      background: var(--bg-secondary);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }

    .message-system {
      align-self: center;
      background: var(--warning);
      color: white;
      font-size: 0.875rem;
      text-align: center;
    }

    .message-meta {
      font-size: 0.75rem;
      opacity: 0.7;
      margin-top: 0.25rem;
    }

    .chat-input {
      display: flex;
      padding: 1rem;
      border-top: 1px solid var(--border);
      gap: 0.5rem;
    }

    .chat-input input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 16px;
    }

    .chat-input button {
      padding: 0.75rem 1.5rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
    }

    .status-panel {
      background: var(--surface);
      padding: 1rem;
      margin: 1rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .case-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .info-card {
      background: var(--bg-secondary);
      padding: 1rem;
      border-radius: var(--radius);
      text-align: center;
    }

    .info-card h4 {
      color: var(--primary);
      margin-bottom: 0.5rem;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-danger { background: var(--danger); color: white; }
    .btn-primary { background: var(--primary); color: white; }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
      }

      .chat-container {
        margin: 0.5rem;
      }

      .case-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>üè¢ Portal Cliente OGA</h1>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <span id="user-name"></span>
      <span id="user-company"></span>
      <button class="btn btn-danger" onclick="logout()">üö™ Cerrar Sesi√≥n</button>
    </div>
  </div>

  <!-- Case Status Panel -->
  <div class="status-panel">
    <h3>üìã Estado de tu Caso</h3>
    <div class="case-info">
      <div class="info-card">
        <h4>üìÑ ID del Caso</h4>
        <div id="case-id">--</div>
      </div>
      <div class="info-card">
        <h4>üè∑Ô∏è Tipo de Tr√°mite</h4>
        <div id="case-type">--</div>
      </div>
      <div class="info-card">
        <h4>üìä Estado Actual</h4>
        <div id="case-status">--</div>
      </div>
      <div class="info-card">
        <h4>üë®‚Äçüíº Oficial Asignado</h4>
        <div id="assigned-officer">--</div>
      </div>
    </div>
    <div style="text-align: center; margin-top: 1rem;">
      <button class="btn btn-primary" onclick="refreshCaseStatus()">üîÑ Actualizar Estado</button>
    </div>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <div class="chat-header">
      <h3>üí¨ Chat con tu Oficial de Acreditaci√≥n</h3>
      <p>Comun√≠cate directamente para resolver dudas sobre tu tr√°mite</p>
    </div>
    
    <div class="chat-messages" id="chat-messages">
      <!-- Mensajes din√°micos -->
    </div>
    
    <div class="chat-input">
      <input 
        type="text" 
        id="message-input" 
        placeholder="Escribe tu mensaje aqu√≠..."
        onkeypress="handleEnterKey(event)"
      >
      <button onclick="sendMessage()">üì§ Enviar</button>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyLZ0usSR8hvItj_V9Hn7bSpgI8lk4TEa1SC_qLlvS53oO2OOnRy8ndRhE2_ngkDT-F/exec';
    let currentUser = null;
    let currentCase = null;

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', () => {
      const userData = localStorage.getItem('currentUser');
      if (!userData) {
        window.location.href = 'index.html';
        return;
      }

      currentUser = JSON.parse(userData);
      
      if (currentUser.rol !== 'Cliente') {
        alert('Acceso denegado. Esta secci√≥n es solo para clientes.');
        window.location.href = 'index.html';
        return;
      }

      document.getElementById('user-name').textContent = currentUser.representante;
      document.getElementById('user-company').textContent = `(${currentUser.empresa})`;

      loadClientCase();
      loadChatMessages();
      
      // Actualizar mensajes cada 10 segundos
      setInterval(loadChatMessages, 10000);
    });

    // Cargar caso del cliente
    async function loadClientCase() {
      try {
        const tickets = await callAPI('getTicketsByRole', {
          userEmail: currentUser.email,
          userRole: 'Cliente',
          userName: currentUser.empresa
        });

        if (tickets.length > 0) {
          currentCase = tickets[0]; // Tomar el caso m√°s reciente
          updateCaseInfo(currentCase);
        } else {
          showNoCaseMessage();
        }
      } catch (error) {
        console.error('Error cargando caso:', error);
        showErrorMessage();
      }
    }

    // Actualizar informaci√≥n del caso
    function updateCaseInfo(caseData) {
      document.getElementById('case-id').textContent = caseData.id;
      document.getElementById('case-type').textContent = caseData.tipoTramite;
      document.getElementById('case-status').textContent = caseData.estado;
      document.getElementById('assigned-officer').textContent = caseData.oficialAsignado || 'No asignado';
    }

    // Mostrar mensaje cuando no hay casos
    function showNoCaseMessage() {
      const statusPanel = document.querySelector('.status-panel');
      statusPanel.innerHTML = `
        <div style="text-align: center; padding: 2rem;">
          <h3>üìù No tienes casos activos</h3>
          <p>Cuando inicies un nuevo tr√°mite, aparecer√° aqu√≠ la informaci√≥n.</p>
        </div>
      `;
    }

    // Cargar mensajes del chat
    async function loadChatMessages() {
      if (!currentCase) return;

      try {
        const messages = await callAPI('getChatMessages', {
          ticketId: currentCase.id
        });

        displayMessages(messages);
      } catch (error) {
        console.error('Error cargando mensajes:', error);
      }
    }

    // Mostrar mensajes en el chat
    function displayMessages(messages) {
      const chatContainer = document.getElementById('chat-messages');
      
      chatContainer.innerHTML = messages.map(msg => {
        const messageClass = msg.remitente === currentUser.empresa ? 'message-client' : 
                           msg.remitente === 'Sistema' ? 'message-system' : 'message-official';
        
        return `
          <div class="message ${messageClass}">
            <div>${msg.mensaje}</div>
            <div class="message-meta">
              ${msg.remitente} - ${new Date(msg.timestamp).toLocaleString()}
            </div>
          </div>
        `;
      }).join('');

      // Scroll al final
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Enviar mensaje
    async function sendMessage() {
      const input = document.getElementById('message-input');
      const message = input.value.trim();

      if (!message || !currentCase) {
        alert('Por favor escribe un mensaje');
        return;
      }

      try {
        const result = await callAPI('sendChatMessage', {
          ticketId: currentCase.id,
          remitente: currentUser.empresa,
          mensaje: message,
          remitenteEmail: currentUser.email
        });

        if (result.success) {
          input.value = '';
          loadChatMessages(); // Recargar mensajes
        } else {
          alert('Error al enviar mensaje');
        }
      } catch (error) {
        alert('Error de conexi√≥n');
        console.error(error);
      }
    }

    // Manejar Enter en el input
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    // Actualizar estado del caso
    function refreshCaseStatus() {
      loadClientCase();
      showNotification('üîÑ Estado actualizado');
    }

    // Mostrar notificaci√≥n
    function showNotification(message) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success);
        color: white;
        padding: 1rem;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        z-index: 1001;
      `;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Mostrar mensaje de error
    function showErrorMessage() {
      const statusPanel = document.querySelector('.status-panel');
      statusPanel.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--danger);">
          <h3>‚ùå Error al cargar informaci√≥n</h3>
          <p>No se pudo conectar con el servidor. Intenta nuevamente.</p>
          <button class="btn btn-primary" onclick="location.reload()">üîÑ Reintentar</button>
        </div>
      `;
    }

    // Cerrar sesi√≥n
    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('userType');
      window.location.href = 'index.html';
    }

    // Funci√≥n API
    async function callAPI(action, params = {}) {
      try {
        const url = new URL(API_URL);
        url.searchParams.append('action', action);
        
        Object.keys(params).forEach(key => {
          if (params[key] !== null && params[key] !== undefined) {
            url.searchParams.append(key, params[key]);
          }
        });

        const response = await fetch(url.toString());
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }
  </script>
</body>
</html>